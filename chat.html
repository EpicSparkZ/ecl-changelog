<!-- ...everything before remains unchanged... -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
  import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-analytics.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDtux10LqHTpjpAyn-W9u7fTod8iRERn-c",
    authDomain: "eclchangelog.firebaseapp.com",
    databaseURL: "https://eclchangelog-default-rtdb.firebaseio.com",
    projectId: "eclchangelog",
    storageBucket: "eclchangelog.firebasestorage.app",
    messagingSenderId: "1046210037396",
    appId: "1:1046210037396:web:299af227e910b308c35681",
    measurementId: "G-YZLMXR7F9E"
  };

  const app = initializeApp(firebaseConfig);
  const analytics = getAnalytics(app);
  const database = getDatabase(app);

  const usernameInput = document.getElementById('username');
  const messageInput = document.getElementById('message');
  const messageContainer = document.getElementById('message-container');
  const announcementText = document.getElementById('announcement-text');

  // Load username from localStorage
  if (localStorage.getItem('username')) {
    usernameInput.value = localStorage.getItem('username');
  }

  usernameInput.addEventListener('input', () => {
    localStorage.setItem('username', usernameInput.value);
  });

  function sendMessage() {
    const username = usernameInput.value.trim();
    const message = messageInput.value.trim();
    if (username && message) {
      const messageRef = ref(database, 'messages/' + Date.now());
      set(messageRef, {
        username: username,
        message: message,
        timestamp: Date.now()
      }).then(() => {
        messageInput.value = '';
        // Lock the username after the first message
        if (!localStorage.getItem('usernameLocked')) {
          usernameInput.readOnly = true;
          localStorage.setItem('usernameLocked', 'true');
        }
      }).catch((error) => {
        console.error("Error sending message:", error);
      });
    }
  }

  // Live message listener
  function loadMessagesLive() {
    const messagesRef = ref(database, 'messages/');
    onValue(messagesRef, (snapshot) => {
      messageContainer.innerHTML = '';
      snapshot.forEach((childSnapshot) => {
        const messageData = childSnapshot.val();
        const messageElement = document.createElement('div');
        messageElement.classList.add('message');

        const usernameSpan = document.createElement('span');
        usernameSpan.classList.add('username');
        usernameSpan.textContent = `${messageData.username}:`;

        if (messageData.username === "EpicSparkZ") {
          usernameSpan.classList.add('rainbow');
        }

        const messageSpan = document.createElement('span');
        messageSpan.classList.add('message-text');
        messageSpan.textContent = ` ${messageData.message}`;

        messageElement.appendChild(usernameSpan);
        messageElement.appendChild(messageSpan);
        messageContainer.appendChild(messageElement);
      });

      // Scroll to bottom
      messageContainer.scrollTop = messageContainer.scrollHeight;
    });
  }

  // Load announcement from Firebase
  function loadAnnouncement() {
    const annRef = ref(database, 'announcement/');
    onValue(annRef, (snapshot) => {
      if (snapshot.exists()) {
        announcementText.textContent = snapshot.val();
      } else {
        announcementText.textContent = 'No announcement.';
      }
    });
  }

  // Enter key triggers send
  messageInput.addEventListener('keydown', function(event) {
    if (event.key === 'Enter') {
      sendMessage();
    }
  });

  // Init
  window.onload = () => {
    loadMessagesLive();
    loadAnnouncement();
  };
</script>
</body>
</html>
